<!DOCTYPE html>
<html>
  <head>
    <title>Page 9</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <header>
      <h1>Page 9</h1>
    </header>

    <nav>
      <ul>
        <li><a href="home.html">Home</a></li>
        <li><a href="page1.html">Page 1</a></li>
        <li><a href="page2.html">Page 2</a></li>
        <li><a href="page3.html">Page 3</a></li>
        <li><a href="page4.html">Page 4</a></li>
        <li><a href="page5.html">Page 5</a></li>
        <li><a href="page6.html">Page 6</a></li>
        <li><a href="page7.html">Page 7</a></li>
        <li><a href="page8.html">Page 8</a></li>
      </ul>
    </nav>

    <div id="customPopup" class="popup">
      <div class="popup-content">
        <p id="popupMessage">Do you want to navigate to Page X?</p>
        <button onclick="confirmNavigation(true)">Yes</button>
        <button onclick="confirmNavigation(false)">No</button>
      </div>
    </div>

    <section id="content-placeholder">
      <h2>Page 9</h2>
      <p>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus lacinia
        odio vitae vestibulum. Pellentesque in ipsum id orci porta dapibus.
        Curabitur non nulla sit amet nisl tempus convallis quis ac lectus.
      </p>
      <!-- You can add more paragraphs, images, or other content as placeholders here -->
    </section>

    <main>
      <h1>Speech Command Recognition</h1>
      <button id="toggleRecognition">Start Recognition</button>

      <div id="classificationResult" style="margin-top: 20px">
        <h2>Classification Result:</h2>
        <p id="resultText">No result yet</p>
      </div>

      <script>
        let recognizer;
        let listening = false;
        let lastRecognizedNumber = null;

        const numberWords = [
          "one",
          "two",
          "three",
          "four",
          "five",
          "six",
          "seven",
          "eight",
          "nine",
        ];

        const numberThresholds = {
          one: 0.99,
          two: 0.99,
          three: 0.95,
          four: 0.999,
          five: 0.99,
          six: 0.99,
          seven: 0.99,
          eight: 0.99,
          nine: 0.99,
        };

        function showPopup(number) {
          document.getElementById(
            "popupMessage"
          ).textContent = `Do you want to navigate to Page ${number}?`;
          document.getElementById("customPopup").style.display = "block";
        }

        function confirmNavigation(shouldNavigate) {
          document.getElementById("customPopup").style.display = "none";
          if (shouldNavigate && lastRecognizedNumber !== null) {
            window.location.href = `page${lastRecognizedNumber}.html`;
          }
        }

        async function initializeRecognizer() {
          recognizer = await speechCommands.create("BROWSER_FFT");
          await recognizer.ensureModelLoaded();
          console.log(recognizer.wordLabels());
        }

        const toggleButton = document.getElementById("toggleRecognition");

        toggleButton.addEventListener("click", async () => {
          if (!recognizer) {
            await initializeRecognizer();
          }

          toggleButton.disabled = true;

          if (listening) {
            recognizer.stopListening();
            listening = false;
            toggleButton.textContent = "Start Recognition";
            toggleButton.disabled = false;
          } else {
            try {
              recognizer.listen(
                (result) => {
                  const scores = Array.from(result.scores); // Convert scores to a regular array
                  const labels = recognizer.wordLabels();
                  const labelsToIgnore = ["go", "left", "right", "up", "down"];

                  // Create an array of label-score pairs
                  let labelScorePairs = scores.map((score, index) => ({
                    label: labels[index],
                    score: score,
                  }));

                  // Filter out the ignored labels
                  labelScorePairs = labelScorePairs.filter(
                    (pair) => !labelsToIgnore.includes(pair.label)
                  );

                  // Sort the pairs by score in descending order
                  labelScorePairs.sort((a, b) => b.score - a.score);

                  // Process the highest scoring label
                  if (labelScorePairs.length > 0) {
                    const highestPair = labelScorePairs[0];
                    const highestLabel = highestPair.label;
                    const highestScore = highestPair.score;

                    document.getElementById(
                      "resultText"
                    ).textContent = `Most probable class: ${highestLabel}, Probability: ${highestScore}`;

                    // Check if the highest label meets its individual threshold
                    if (
                      numberWords.includes(highestLabel) &&
                      highestScore >= (numberThresholds[highestLabel] || 0.75)
                    ) {
                      lastRecognizedNumber =
                        numberWords.indexOf(highestLabel) + 1;
                      showPopup(lastRecognizedNumber);
                    } else if (
                      highestLabel === "yes" &&
                      lastRecognizedNumber !== null
                    ) {
                      confirmNavigation(true);
                    } else if (highestLabel === "no") {
                      confirmNavigation(false);
                    }
                  }
                },
                {
                  includeSpectrogram: true,
                  probabilityThreshold: 0.75, // Consider lowering this if necessary
                }
              );

              listening = true;
              toggleButton.textContent = "Stop Recognition";
            } catch (error) {
              console.error("Error in speech recognition: ", error);
            } finally {
              toggleButton.disabled = false;
            }
          }
        });
      </script>
    </main>
  </body>
</html>
